<%- include('../layouts/userheader.ejs') %>

<style>
    body {
        margin: 0;
        color: #4b537b;
        background: #61557d;
        font: 600 16px/18px 'Open Sans', sans-serif;
    }
    .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .password-wrapper .input {
        width: 100%;
    }

    .password-wrapper .fa-eye {
        position: absolute;
        right: 10px;
        cursor: pointer;
        color: white; /* Change the eye icon color to white */
    }
</style>

<div class="login-wrap">
    <div class="login-html">
        <label for="tab-2" class="tab">Reset Password</label>
        <div class="login-form">
            <div class="reset-password-htm">
                <% if (typeof logoutmsg !== 'undefined' && logoutmsg) { %>
                    <div class="alert alert-success">
                        <%= logoutmsg %>
                    </div>
                <% } %>
                <form id="reset-password-form" action="/user/resetPassword" method="post">
                    <div class="group">
                        <label for="email" class="label">Enter Your Email</label>
                        <input id="email" name="email" type="text" class="input">
                        <div class="error"></div>
                    </div>
                    <div class="group">
                        <label for="new-password" class="label">New Password</label>
                        <input id="new-password" name="new-password" type="password" class="input">
                        <div class="error"></div>
                    </div>
                    <div class="group">
                        <label for="confirm-password" class="label">Confirm Password</label>
                        <input id="confirm-password" name="confirm-password" type="password" class="input">
                        <div class="error"></div>
                    </div>
                    <div class="group">
                        <input type="submit" class="button" value="Reset Password">
                    </div>
                    <div class="hr"></div>
                    <div class="foot-lnk">
                        <a href="/user/login" style="color: rgb(241, 237, 237);">Back to Sign In</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const form = document.getElementById('reset-password-form');
    const email = document.getElementById('email');
    const password = document.getElementById('new-password');
    const confpassword = document.getElementById('confirm-password');

    form.addEventListener('submit', async e => {
        console.log(addEventListener);
        e.preventDefault();

        validateInputs();
        if (isValid()) {
            const formData = {
                email: email.value.trim(),
                password: password.value.trim(),
                confpassword: confpassword.value.trim()
            }

            try {
                const response = await fetch('/user/resetPassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();
                if (response.ok) {
                    Swal.fire({
                        title: 'Success',
                        text: result.message,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = '/user/login';
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.message,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            } catch (error) {
                console.error('Error during fetch:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    });

    const isValid = () => {
        return email.parentElement.classList.contains('success') &&
               password.parentElement.classList.contains('success') &&
               confpassword.parentElement.classList.contains('success');
    }

    const setError = (element, message) => {
        const inputControl = element.parentElement;
        const errorDisplay = inputControl.querySelector('.error');

        errorDisplay.innerText = message;
        inputControl.classList.add('error');
        inputControl.classList.remove('success');
    }

    const setSuccess = element => {
        const inputControl = element.parentElement;
        const errorDisplay = inputControl.querySelector('.error');

        errorDisplay.innerText = '';
        inputControl.classList.add('success');
        inputControl.classList.remove('error');
    };

    const isValidEmail = email => {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }

    const validateInputs = () => {
        const emailValue = email.value.trim();
        const passwordValue = password.value.trim();
        const confPasswordValue = confpassword.value.trim();

        if (emailValue === '') {
            setError(email, 'Email is required');
        } else if (!isValidEmail(emailValue)) {
            setError(email, 'Provide a valid email address');
        } else {
            setSuccess(email);
        }

        if (passwordValue === '') {
            setError(password, 'Password is required');
        } else {
            setSuccess(password);
        }

        if (confPasswordValue === '') {
            setError(confpassword, 'Confirmation password is required');
        } else if (confPasswordValue !== passwordValue) {
            setError(confpassword, 'Passwords do not match');
        } else {
            setSuccess(confpassword);
        }
    }
</script>

<%- include('../layouts/footer') %>
